<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSS Kinetic Lyric Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body {
            margin: 0;
            background-color: #000;
            color: #fff;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .lyric-line {
            position: absolute;
            font-size: 4vw;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            width: 80%;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .gold-highlight {
            color: #FFD700;
        }

        /* Controls for Recording Mode */
        #controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            font-family: monospace;
        }

        button {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
        }

        button:hover {
            background: #555;
        }

        #output {
            margin-top: 10px;
            width: 300px;
            height: 100px;
            background: #111;
            color: #0f0;
            border: 1px solid #333;
            font-size: 10px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <div id="container">
        <!-- Lyrics will be injected here -->
    </div>

    <div id="controls">
        <h3 style="margin-top:0; color:#FFD700;">TSS Lyric Syncer</h3>
        <p style="font-size:12px; margin-bottom:10px;">
            1. Click "Load Audio"<br>
            2. Click "Start Recording"<br>
            3. Press <strong>SPACE</strong> at start of each line<br>
            4. Copy JSON outputs to G
        </p>
        <button id="btnLoad">Load Audio</button>
        <button id="btnPlay" disabled>Start Recording (Play)</button>
        <button id="btnExport">Export JSON</button>
        <br>
        <div id="currentLineDisplay" style="margin-top:10px; color: cyan;">Next: ...</div>
        <textarea id="output" readonly></textarea>
    </div>

    <audio id="audioTrack" src="./the-synergy-stage.mp3"></audio>

    <script>
        // --- LYRICS DATA ---
        // G: Parsing the provided markdown lyrics into a clean array structure
        const rawLyrics = `
ずっと1人だった
ずっとがんばってここまできた
だけどなにかが足りない気がしてもがいてた
---
次々にスターへと駆け上がる人
私もいつかと必死でくらいついてきた
もう少しで届きそうな気がしてたんだ
---
そしてわかった　そして出会えた
足りない何かは仲間だったこと
手を伸ばした先のむこうに
しっかりと掴んでくれる安心感
仲間と一緒に生み出すシナジー
---
ずっと孤独だった
ずっと家族にも理解されなかった
そろそろ会社に戻ったらなんて言われて悔しかった
---
キラキラと見えた世界には嫉妬や
欲望が渦巻いていたそれでも
もう少しで抜け出せそうな気がしたんだ
---
そしてわかった　そして出会えた
踏み出さなければ出会えなかった
何度も流した涙はきっと
ここにいるみんなと出会うための時間
仲間と一緒に生み出すシナジー
---
TSS これからもずっと
TSS 傷を舐め合うんじゃない
TSS プロフェッショナルとしてのシナジー
TSS いつまでもずっと
TSS 夢語り合い叶えてくシナジー
---
そしてわかった　そして出会えた
踏み出さなければ変わらなかった
何度も流した涙はきっと
今ここから起こす奇跡手繰り寄せるため
仲間と一緒に生み出すシナジー
---
TSS これからもずっと
TSS 傷を舐め合うんじゃない
TSS プロフェッショナルとしてのシナジー
TSS いつまでもずっと
TSS 夢語り合い叶えてくシナジー
---
TSS これからはずっと
TSS 夢物語なんかじゃない
TSS 世界を変えていくシナジー
TSS いつまでもずっと
TSS 夢語り合い叶えてくシナジー
    `;

        // Process raw lyrics into array (ignoring --- separators for now, treating as flat list for syncing)
        const lyrics = rawLyrics.split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0 && line !== '---');

        let timestamps = []; // To separate store {time: 0, text: "..."}
        let currentIndex = 0;
        let isRecording = false;

        const audio = document.getElementById('audioTrack');
        const container = document.getElementById('container');
        const btnLoad = document.getElementById('btnLoad');
        const btnPlay = document.getElementById('btnPlay');
        const btnExport = document.getElementById('btnExport');
        const output = document.getElementById('output');
        const currentLineDisplay = document.getElementById('currentLineDisplay');

        // Display first line preview
        if (lyrics.length > 0) currentLineDisplay.innerText = "Next: " + lyrics[0];

        // --- SETUP CONTROLS ---

        btnLoad.addEventListener('click', () => {
            // Just ensures audio is ready and context is unlocked
            audio.load();
            btnPlay.disabled = false;
            btnPlay.innerText = "Start Recording (Play)";
            btnLoad.innerText = "Audio Loaded";
        });

        btnPlay.addEventListener('click', () => {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });

        btnExport.addEventListener('click', () => {
            output.select();
            document.execCommand('copy');
            alert("JSON copied to clipboard! Send this to G.");
        });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && isRecording) {
                e.preventDefault(); // Prevent scrolling
                recordTimestamp();
            }
        });

        function startRecording() {
            isRecording = true;
            currentIndex = 0;
            timestamps = [];
            output.value = "";
            btnPlay.innerText = "Stop Recording";

            // Reset View
            container.innerHTML = "";

            audio.currentTime = 0;
            audio.play();

            // Show first line ready
            showNextLinePreview();
        }

        function stopRecording() {
            isRecording = false;
            audio.pause();
            btnPlay.innerText = "Start Recording (Play)";
            updateOutput();
        }

        function recordTimestamp() {
            if (currentIndex >= lyrics.length) return;

            const time = audio.currentTime;
            const text = lyrics[currentIndex];

            // Store
            timestamps.push({ time: parseFloat(time.toFixed(2)), text: text });

            // Visual Feedback (Flash the text)
            showTextOnScreen(text);

            // Advance
            currentIndex++;
            showNextLinePreview();
            updateOutput();
        }

        function showNextLinePreview() {
            if (currentIndex < lyrics.length) {
                currentLineDisplay.innerText = "Next: " + lyrics[currentIndex];
                currentLineDisplay.style.color = "#FFD700";
            } else {
                currentLineDisplay.innerText = "End of Lyrics";
                currentLineDisplay.style.color = "#aaa";
            }
        }

        function showTextOnScreen(text) {
            // Simple GSAP flash for feedback
            const div = document.createElement('div');
            div.className = 'lyric-line';
            div.innerText = text;
            container.appendChild(div);

            // Center recenter
            gsap.set(div, { opacity: 0, scale: 0.5, y: 50 });
            gsap.to(div, { opacity: 1, scale: 1, y: 0, duration: 0.1 });
            gsap.to(div, { opacity: 0, scale: 1.5, filter: 'blur(10px)', duration: 0.5, delay: 0.8, onComplete: () => div.remove() });
        }

        function updateOutput() {
            output.value = JSON.stringify(timestamps, null, 2);
        }

        // Auto-scroll output to bottom
        // output.scrollTop = output.scrollHeight;

    </script>
</body>

</html>