<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSS Dashboard</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --white: #FFFFFF;
            --off-white: #F9F9F9;
            --light-gray: #F2F2F2;
            --primary: #D4AF37;
            --primary-dark: #B8960C;
            --primary-light: rgba(212, 175, 55, 0.1);
            --primary-glow: rgba(212, 175, 55, 0.4);
            --accent: #FFD700;
            --text-dark: #111111;
            --text-gray: #666666;
            --border: rgba(0, 0, 0, 0.08);
            --success: #22C55E;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gradient-primary: linear-gradient(135deg, #D4AF37, #FFD700);
            --gradient-luxury: linear-gradient(to right, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
            --gradient-dark: linear-gradient(135deg, #1a1a1a, #000000);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--off-white);
            color: var(--text-dark);
            min-height: 100vh;
        }

        header {
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(135deg, #FBF5B7, #E5C158, #D4AF37, #C6A355);
            color: #5C4010;
            box-shadow: 0 4px 30px rgba(212, 175, 55, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        /* Shine effect */
        header::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 60%);
            opacity: 0.1;
            transform: rotate(30deg);
            pointer-events: none;
        }

        h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 32px;
            font-weight: 600;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: #4A3200;
            background: none;
            -webkit-text-fill-color: initial;
            text-shadow: 0 1px 1px rgba(255,255,255,0.5);
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .header-sub {
            font-family: 'Montserrat', sans-serif;
            font-size: 11px;
            color: #5C4010;
            letter-spacing: 0.4em;
            font-weight: 500;
            text-transform: uppercase;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px var(--primary-glow);
        }

        .stat-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 36px;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-family: 'Montserrat', sans-serif;
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 5px;
            letter-spacing: 0.15em;
        }

        .section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }

        .section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            letter-spacing: 0.15em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--primary-light), transparent);
        }

        /* MEMBERS TABLE */
        .members-table {
            width: 100%;
            border-collapse: collapse;
        }

        .members-table th,
        .members-table td {
            padding: 14px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .members-table th {
            font-family: 'Montserrat', sans-serif;
            font-size: 10px;
            color: var(--text-gray);
            letter-spacing: 0.15em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .members-table td {
            font-size: 14px;
        }

        .member-row {
            transition: background 0.2s;
        }

        .member-row:hover {
            background: var(--primary-light);
        }

        .member-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 14px;
            margin-right: 10px;
            vertical-align: middle;
            box-shadow: 0 2px 8px var(--primary-glow);
        }

        .member-name {
            font-weight: 600;
        }

        .token-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--primary-light);
            color: var(--primary-dark);
            padding: 5px 12px;
            border-radius: 20px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 12px;
            border: 1px solid var(--primary);
        }

        /* RANKING */
        .ranking-list {
            list-style: none;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 14px;
            color: var(--text-gray);
        }

        .ranking-item:nth-child(1) .ranking-number {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.4);
        }

        .ranking-item:nth-child(2) .ranking-number {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
            color: white;
        }

        .ranking-item:nth-child(3) .ranking-number {
            background: linear-gradient(135deg, #CD7F32, #A0522D);
            color: white;
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-name {
            font-weight: 600;
            font-size: 14px;
        }

        .ranking-role {
            font-size: 11px;
            color: var(--text-gray);
        }

        .ranking-tokens {
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        /* RECENT ACTIVITY */
        .activity-list {
            list-style: none;
        }

        .activity-item {
            display: flex;
            gap: 12px;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 14px;
        }

        .activity-text strong {
            color: var(--primary-dark);
        }

        .activity-time {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 3px;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* LOADING */
        .loading {
            display: flex;
            justify-content: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* BUTTONS */
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 4px 15px var(--primary-glow);
            transition: all 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px var(--primary-glow);
        }

        /* FORM INPUTS */
        .input-label {
            display: block;
            font-family: 'Montserrat', sans-serif;
            font-size: 10px;
            color: var(--primary);
            letter-spacing: 0.15em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .text-input {
            width: 100%;
            background: var(--light-gray);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 14px;
            color: var(--text-dark);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea.text-input {
            min-height: 100px;
            resize: vertical;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            main {
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>TSS DASHBOARD</h1>
        <div class="header-sub">TEAM SYNERGY STAGE ADMIN</div>
    </header>

    <main>
        <!-- STATS -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="totalMembers">-</div>
                <div class="stat-label">TOTAL MEMBERS</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üíé</div>
                <div class="stat-value" id="totalTokens">-</div>
                <div class="stat-label">TOTAL TSST</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-value" id="totalPosts">-</div>
                <div class="stat-label">TOTAL POSTS</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="completedTasks">-</div>
                <div class="stat-label">COMPLETED TASKS</div>
            </div>
        </div>

        <div class="two-column">
            <!-- TOKEN RANKING -->
            <div class="section">
                <div class="section-title">üèÜ TOKEN RANKING</div>
                <ul class="ranking-list" id="rankingList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                </ul>
            </div>

            <!-- RECENT ACTIVITY -->
            <div class="section">
                <div class="section-title">üìä RECENT ACTIVITY</div>
                <ul class="activity-list" id="activityList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div>„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                    </div>
                </ul>
            </div>
        </div>

        <!-- MEMBERS TABLE -->
        <div class="section">
            <div class="section-title">üë• ALL MEMBERS</div>
            <table class="members-table">
                <thead>
                    <tr>
                        <th>NAME</th>
                        <th>ROLE</th>
                        <th>TSST</th>
                        <th>JOINED</th>
                    </tr>
                </thead>
                <tbody id="membersTable">
                    <tr>
                        <td colspan="4">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <center style="margin-top: 20px;">
                <button class="btn-primary" onclick="loadData()">üîÑ REFRESH DATA</button>
            </center>
        </div>

        <!-- ANNOUNCEMENT POSTING -->
        <div class="section">
            <div class="section-title">üì¢ POST ANNOUNCEMENT</div>
            <div style="margin-bottom: 15px;">
                <label class="input-label">ANNOUNCEMENT CONTENT</label>
                <textarea id="announcementContent" rows="4" class="text-input"
                    placeholder="„Ç¢„Éä„Ç¶„É≥„Çπ„É°„É≥„Éà„ÇíÂÖ•Âäõ...ÔºàURL„ÅØËá™ÂãïÁöÑ„Å´„É™„É≥„ÇØ„Å´„Å™„Çä„Åæ„ÅôÔºâ"></textarea>
            </div>

            <!-- Link Attachment -->
            <div style="margin-bottom: 15px;">
                <label class="input-label">üîó LINK URLÔºà‰ªªÊÑèÔºâ</label>
                <input type="url" id="announcementLink" class="text-input" placeholder="https://example.com">
                <input type="text" id="announcementLinkLabel" class="text-input" style="margin-top: 8px;"
                    placeholder="„É™„É≥„ÇØ„ÅÆ„É©„Éô„É´Ôºà‰ªªÊÑèÔºâ">
            </div>

            <!-- Image Upload -->
            <div style="margin-bottom: 15px;">
                <label class="input-label">üì∑ IMAGEÔºà‰ªªÊÑè / 2MB‰ª•‰∏ãÊé®Â•®Ôºâ</label>
                <input type="file" id="announcementImage" accept="image/*" class="text-input"
                    onchange="previewImage(this)">
                <div id="imagePreview" style="margin-top: 10px; display: none;">
                    <img id="previewImg"
                        style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid var(--border);">
                    <button type="button" onclick="clearImage()"
                        style="margin-left: 10px; background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 11px;">‚úï
                        ÂâäÈô§</button>
                </div>
            </div>

            <!-- PDF/Document Link -->
            <div style="margin-bottom: 15px;">
                <label class="input-label">üìÑ PDF / DOCUMENT LINKÔºà‰ªªÊÑèÔºâ</label>
                <input type="url" id="announcementPdfLink" class="text-input"
                    placeholder="Google Drive / Dropbox „Å™„Å©„ÅÆÂÖ±Êúâ„É™„É≥„ÇØ">
                <p style="margin-top: 5px; font-size: 10px; color: var(--text-gray);">üí° PDF„ÅØGoogle
                    Drive„ÇÑDropbox„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„ÄÅÂÖ±Êúâ„É™„É≥„ÇØ„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ</p>
            </div>

            <button class="btn-primary" onclick="postAnnouncement()">üì¢ POST ANNOUNCEMENT</button>
            <p style="margin-top: 12px; font-size: 11px; color: var(--text-gray);">‚Äª ÊäïÁ®ø„Åï„Çå„Åü„Ç¢„Éä„Ç¶„É≥„Çπ„É°„É≥„Éà„ÅØ„É°„Ç§„É≥„Ç¢„Éó„É™„ÅÆHOMEÁîªÈù¢„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô
            </p>
        </div>

        <!-- YOUTUBE SETTINGS -->
        <div class="section">
            <div class="section-title">üé¨ YOUTUBE SETTINGS</div>
            <div style="margin-bottom: 15px;">
                <label class="input-label">VIDEO ID</label>
                <input type="text" id="youtubeVideoId" class="text-input"
                    placeholder="YouTube Video ID (e.g. dQw4w9WgXcQ)">
            </div>
            <div style="margin-bottom: 15px;">
                <label class="input-label">CAPTION / „Ç≠„É£„Éó„Ç∑„Éß„É≥</label>
                <input type="text" id="youtubeCaptionInput" class="text-input" placeholder="„Ç≠„É£„Éó„Ç∑„Éß„É≥„ÇíÂÖ•Âäõ...">
            </div>
            <button class="btn-primary" onclick="saveYouTubeSettings()">üíæ SAVE SETTINGS</button>
        </div>
    </main>

    <script>
        // ============ CONFIGURATION ============
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx92liR07RuPcJDkjol2ORnP8Met2t-m0TeZ0MnzGPBTchnxdAXIOM6-xm4E0nLyFNqPw/exec';

        // ============ LOAD DATA ============
        async function loadData() {
            try {
                // Fetch stats from Backend
                const statsRes = await fetch(`${SCRIPT_URL}?action=stats`);
                const statsData = await statsRes.json();

                // Fetch members
                const membersRes = await fetch(`${SCRIPT_URL}?action=members`);
                const membersData = await membersRes.json();

                // Fetch posts
                const postsRes = await fetch(`${SCRIPT_URL}?action=posts`);
                const postsData = await postsRes.json();

                const members = membersData.members || [];
                const posts = postsData.posts || [];

                renderStats(statsData, members, posts);
                renderRanking(statsData.topMembers || members);
                renderMembers(members);
                
                // Prioritize backend token logs if available, otherwise fallback to posts
                if (statsData.recentActivity && statsData.recentActivity.length > 0) {
                    renderActivity(statsData.recentActivity, 'log');
                } else {
                    renderActivity(posts, 'post');
                }

            } catch (error) {
                console.error('Error loading data:', error);
                // Show error state
                document.getElementById('totalMembers').textContent = '!';
                document.getElementById('totalTokens').textContent = '!';
                document.getElementById('totalPosts').textContent = '!';
                document.getElementById('completedTasks').textContent = '!';
            }
        }

        function renderStats(stats, members, posts) {
            document.getElementById('totalMembers').textContent = stats.totalMembers || members.length || 0;
            
            // Show Total Issued (Lifetime) as main stat, Balance as sub
            const totalEarned = stats.totalTokensIssued || stats.totalTokens || 0;
            const currentBalance = stats.totalTokens || 0;
            document.getElementById('totalTokens').textContent = totalEarned;
            // Update label to show balance context
            const tokenLabel = document.querySelector('#totalTokens + .stat-label');
            if(tokenLabel) tokenLabel.textContent = `TOTAL EARNED (BAL: ${currentBalance})`;

            document.getElementById('totalPosts').textContent = stats.totalPosts || posts.length || 0;
            document.getElementById('completedTasks').textContent = stats.completedTasks || '-';
        }

        function renderRanking(members) {
            // Sort by Total Earned (Lifetime Contribution)
            const sorted = [...members].sort((a, b) => (b.totalEarned || b.tokens || 0) - (a.totalEarned || a.tokens || 0)).slice(0, 5);
            const list = document.getElementById('rankingList');

            if (sorted.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÜ</div>
                        <div>„Åæ„Å†„É°„É≥„Éê„Éº„Åå„ÅÑ„Åæ„Åõ„Çì</div>
                    </div>
                `;
                return;
            }

            list.innerHTML = sorted.map((member, index) => `
                <li class="ranking-item">
                    <div class="ranking-number">${index + 1}</div>
                    <div class="ranking-info">
                        <div class="ranking-name">${escapeHtml(member.name)}</div>
                        <div class="ranking-role">${escapeHtml(member.role || '„É°„É≥„Éê„Éº')}</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="ranking-tokens">${member.totalEarned || member.tokens || 0}</div>
                        <div style="font-size:9px; color:#aaa;">LIFETIME</div>
                    </div>
                </li>
            `).join('');
        }

        function renderMembers(members) {
            const table = document.getElementById('membersTable');

            if (members.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="4">
                            <div class="empty-state">
                                <div class="empty-state-icon">üë•</div>
                                <div>„É°„É≥„Éê„Éº„Åå„ÅÑ„Åæ„Åõ„Çì</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            table.innerHTML = members.map(member => `
                <tr class="member-row">
                    <td>
                        <span class="member-avatar">${(member.name || '?').charAt(0).toUpperCase()}</span>
                        <span class="member-name">${escapeHtml(member.name)}</span>
                    </td>
                    <td>${escapeHtml(member.role || '„É°„É≥„Éê„Éº')}</td>
                    <td><span class="token-badge">üíé ${member.tokens || 0}</span></td>
                    <td>${formatDate(member.joinedat || member.joinedAt || member.timestamp)}</td>
                </tr>
            `).join('');
        }

        function renderActivity(data, mode = 'post') {
            const list = document.getElementById('activityList');

            if (!data || data.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div>„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                    </div>
                `;
                return;
            }

            let activities = [];

            if (mode === 'log') {
                // Parse Token Logs
                activities = data.map(log => {
                    let actionText = '„ÅåÊ¥ªÂãï„Åó„Åæ„Åó„Åü';
                    let icon = 'üìå';
                    
                    switch(log.action) {
                        case 'post': 
                            actionText = '„ÅåÊäïÁ®ø„Åó„Åæ„Åó„Åü'; 
                            icon = 'üìù'; 
                            break;
                        case 'comment': 
                            actionText = '„Åå„Ç≥„É°„É≥„Éà„Åó„Åæ„Åó„Åü'; 
                            icon = 'üí¨'; 
                            break;
                        case 'like_received': 
                            actionText = '„Åå„ÅÑ„ÅÑ„Å≠„ÇíÂèó„ÅëÂèñ„Çä„Åæ„Åó„Åü'; 
                            icon = '‚ù§Ô∏è'; 
                            break;
                        case 'task_add': 
                            actionText = '„Åå„Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü'; 
                            icon = 'üìå'; 
                            break;
                        case 'task_complete': 
                            actionText = '„Åå„Çø„Çπ„ÇØ„ÇíÂÆå‰∫Ü„Åó„Åæ„Åó„Åü'; 
                            icon = '‚úÖ'; 
                            break;
                        case 'schedule_add': 
                            actionText = '„Åå‰∫àÂÆö„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü'; 
                            icon = 'üìÖ'; 
                            break;
                        case 'manual':
                            actionText = '„Å´„Éà„Éº„ÇØ„É≥„Åå‰ªò‰∏é„Åï„Çå„Åæ„Åó„Åü';
                            icon = 'üíé';
                            break;
                    }

                    // Append Amount if positive
                    const amountStr = log.amount > 0 ? ` (+${log.amount} TSST)` : '';

                    return {
                        user: log.user,
                        action: actionText,
                        content: (log.description || '') + amountStr,
                        time: formatRelativeTime(log.timestamp),
                        icon: icon
                    };
                });
            } else {
                // Fallback: Post only mode
                activities = data.slice(0, 5).map(post => ({
                    user: post.author,
                    action: '„ÅåÊäïÁ®ø„Åó„Åæ„Åó„Åü',
                    time: formatRelativeTime(post.timestamp),
                    content: (post.content || '').substring(0, 30) + '...',
                    icon: 'üìù'
                }));
            }

            list.innerHTML = activities.map(activity => `
                <li class="activity-item">
                    <div class="activity-icon">${activity.icon}</div>
                    <div class="activity-content">
                        <div class="activity-text"><strong>${escapeHtml(activity.user)}</strong> ${activity.action}</div>
                        <div class="activity-text" style="font-size:12px; color:#666;">${escapeHtml(activity.content)}</div>
                        <div class="activity-time">${activity.time}</div>
                    </div>
                </li>
            `).join('');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
            } catch {
                return '-';
            }
        }

        function formatRelativeTime(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                const now = new Date();
                const diff = Math.floor((now - date) / 1000);

                if (diff < 60) return '„Åü„Å£„Åü‰ªä';
                if (diff < 3600) return `${Math.floor(diff / 60)}ÂàÜÂâç`;
                if (diff < 86400) return `${Math.floor(diff / 3600)}ÊôÇÈñìÂâç`;
                return `${Math.floor(diff / 86400)}Êó•Ââç`;
            } catch {
                return '';
            }
        }

        // ============ ANNOUNCEMENT POSTING ============
        let currentImageData = null;

        function previewImage(input) {
            const file = input.files[0];
            if (!file) return;

            // Check file size (2MB limit)
            if (file.size > 2 * 1024 * 1024) {
                alert('‚ö†Ô∏è ÁîªÂÉè„Çµ„Ç§„Ç∫„ÅØ2MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                currentImageData = e.target.result;
                document.getElementById('previewImg').src = currentImageData;
                document.getElementById('imagePreview').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            currentImageData = null;
            document.getElementById('announcementImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        async function postAnnouncement() {
            const content = document.getElementById('announcementContent').value.trim();
            if (!content) {
                alert('„Ç¢„Éä„Ç¶„É≥„Çπ„É°„É≥„Éà„ÅÆÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // Get attachment data
            const linkUrl = document.getElementById('announcementLink').value.trim();
            const linkLabel = document.getElementById('announcementLinkLabel').value.trim() || linkUrl;
            const pdfLink = document.getElementById('announcementPdfLink').value.trim();

            // Build attachments array
            const attachments = [];

            if (linkUrl) {
                attachments.push({
                    type: 'link',
                    url: linkUrl,
                    label: linkLabel
                });
            }

            if (currentImageData) {
                attachments.push({
                    type: 'image',
                    data: currentImageData
                });
            }

            if (pdfLink) {
                attachments.push({
                    type: 'pdf',
                    url: pdfLink,
                    label: 'PDFË≥áÊñô'
                });
            }

            // Send to Backend
            try {
                const btn = document.querySelector('button[onclick="postAnnouncement()"]');
                const originalText = btn.textContent;
                btn.textContent = 'ÈÄÅ‰ø°‰∏≠...';
                btn.disabled = true;

                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'postAnnouncement',
                        author: 'TSSÈÅãÂñ∂',
                        content: content,
                        attachments: attachments
                    })
                });

                // Clear form
                document.getElementById('announcementContent').value = '';
                document.getElementById('announcementLink').value = '';
                document.getElementById('announcementLinkLabel').value = '';
                document.getElementById('announcementPdfLink').value = '';
                clearImage();

                btn.textContent = originalText;
                btn.disabled = false;

                alert('‚úÖ „Ç¢„Éä„Ç¶„É≥„Çπ„É°„É≥„Éà„ÇíÂÖ®„É¶„Éº„Ç∂„Éº„Å´ÈÖç‰ø°„Åó„Åæ„Åó„ÅüÔºÅ');

            } catch (e) {
                console.error(e);
                alert('ÈÄÅ‰ø°„Ç®„É©„Éº: ' + e);
            }
        }

        // ============ YOUTUBE SETTINGS ============
        function loadYouTubeSettings() {
            const settings = JSON.parse(localStorage.getItem('tss_youtube_settings') || '{}');
            document.getElementById('youtubeVideoId').value = settings.videoId || '';
            document.getElementById('youtubeCaptionInput').value = settings.caption || '';
        }

        function saveYouTubeSettings() {
            const videoId = document.getElementById('youtubeVideoId').value.trim();
            const caption = document.getElementById('youtubeCaptionInput').value.trim();

            if (!videoId) {
                alert('Video ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const settings = {
                videoId: videoId,
                caption: caption
            };

            localStorage.setItem('tss_youtube_settings', JSON.stringify(settings));
            alert('‚úÖ YouTubeË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ\n„É°„Ç§„É≥„Ç¢„Éó„É™„ÅÆHOMEÁîªÈù¢„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ');
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadYouTubeSettings();
        });
    </script>
</body>

</html>